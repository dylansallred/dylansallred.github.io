<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Call Logger</title>
    <style>
/* ==============================
   :root - Color and Font Variables
================================= */
:root {
    --background-color: #1e1e1e;
    --primary-color: #2a2a2a;
    --secondary-color: #3a3a3a;
    --text-color: #e0e0e0;
    --accent-color: #0078d4;
    --accent-hover-color: #1e5784;
    --error-color: #d32f2f;
    --error-hover-color: #9f1818;
    --success-color: #4caf50;
    --success-hover-color: #3d7240;
    --warning-color: #ff9800;
    --warning-hover-color: #b46c02;
    --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* ==============================
   Reset and Base Styles
================================= */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: var(--font-family);
    background-color: var(--background-color);
    color: var(--text-color);
    height: 100vh;
    overflow: hidden;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* Internet Explorer 10+ */
}

body::-webkit-scrollbar {
    display: none; /* WebKit */
}

/* ==============================
   Typography
================================= */
h1, h2 {
    color: var(--text-color);
    margin-bottom: 20px;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
}

h1 {
    font-size: 2.5em;
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 10px;
}

h2 {
    font-size: 1.8em;
    position: relative;
    padding-left: 15px;
    display: flex;
    align-items: baseline;
}

h2::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 5px;
    height: 70%;
    background-color: var(--accent-color);
    border-radius: 2px;
}

/* ==============================
   Layout
================================= */
.container {
    width: 100%;
    max-width: 100%;
    height: 100vh;
    display: flex;
    flex-direction: column;
    margin: 0 auto;
    padding: 10px;
}

.hidden {
    display: none !important;
}

.main-menu {
    display: flex;
    flex-direction: column;
    height: 100%;
    animation: fadeIn 0.5s ease-out;
    transition: opacity 0.3s ease;
}

.main-menu.fade-out {
    opacity: 0;
}

.sticky-header {
    flex-shrink: 0;
    padding-bottom: 20px;
}

.logs-section {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.logs-section h2 {
    display: flex;
    align-items: center;
    gap: 10px;
}

#exportFilteredLogsBtn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    transition: transform 0.2s ease, opacity 0.3s ease;
    opacity: 1;
}

#exportFilteredLogsBtn.hidden {
    opacity: 0;
    pointer-events: none;
}

#exportFilteredLogsBtn:hover {
    transform: scale(1.1);
}

#exportFilteredLogsBtn svg {
    width: 20px;
    height: 20px;
    color: var(--text-color);
}

#exportFilteredLogsBtn svg:hover {
    color: var(--accent-color);
}

.table-container {
    flex-grow: 1;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
    border-radius: 5px;
}

.table-container::-webkit-scrollbar {
    display: none;
}

/* ==============================
   Buttons
================================= */
button,
.close-btn,
.save-btn,
.create-btn,
.export-btn,
.import-btn,
.delete-all-btn,
.generate-btn,
.add-equipment-btn,
.remove-equipment-btn,
.modal-btn {
    border: .5px solid #ffffff3b;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;

}

button:hover,
.close-btn:hover,
.save-btn:hover,
.create-btn:hover,
.export-btn:hover,
.import-btn:hover,
.delete-all-btn:hover,
.generate-btn:hover,
.add-equipment-btn:hover,
.remove-equipment-btn:hover,
.modal-btn:hover {
    transform: translateY(-2px);
    color: var(--text-color);
}

.create-btn,
.export-btn,
.import-btn,
.delete-all-btn,
.generate-btn,
.close-btn {
    padding: 10px 20px;
    border-radius: 25px;
    color: var(--background-color);
    box-shadow: inset 0px 0px 1.5px 0.25px #FFF;
}

.create-btn {
    background-color: var(--success-color);
}

.create-btn:hover {
    background-color: var(--success-hover-color);
}

.delete-btn {
    transition: all 0.3s;
}

.delete-btn:hover {
    color: var(--error-color);
    transform: scale(1.2);
}

.export-btn {
    background-color: var(--accent-color);
}

.export-btn:hover {
    background-color: var(--accent-hover-color);
}

.import-btn {
    background-color: var(--warning-color);
}

.import-btn:hover {
    background-color: var(--warning-hover-color);
}

.delete-all-btn {
    background-color: var(--error-color);
}

.delete-all-btn:hover {
    background-color: var(--error-hover-color);
}

.generate-btn {
    background-color: var(--accent-color);
}

.generate-btn:hover {
    background-color: var(--accent-hover-color);
}

.close-btn {
    background-color: var(--error-color);
}

.close-btn:hover {
    background-color: var(--error-hover-color);
    transform: translateY(-2px);
    color: var(--text-color);
}

.save-btn {
    background-color: var(--success-color);
}

.save-btn:hover {
    background-color: var(--success-hover-color);
    transform: scale(1.05);
}

.help-btn {
    font-size: 1em;
    padding: 3px 7px;
    margin-bottom: 1px;
    margin-top: 5px;
    border-radius: 5px;
    min-width: 100px;
}


#overwriteBtn {
    background-color: var(--warning-color);
}

#overwriteBtn:hover {
    background-color: var(--warning-hover-color);
}

#appendBtn {
    background-color: var(--success-color);
}

#appendBtn:hover {
    background-color: var(--success-hover-color);
}

#cancelImportBtn {
    background-color: var(--error-color);
}

#cancelImportBtn:hover {
    background-color: var(--error-hover-color);
}

.add-equipment-btn {
    background-color: var(--accent-color);
}

.add-equipment-btn:hover {
    background-color: var(--accent-hover-color);
}

.remove-equipment-btn {
    background-color: var(--error-color);
}

.remove-equipment-btn:hover {
    background-color: var(--error-hover-color);
}

/* ==============================
   Search Bar
================================= */

.search-input {
    width: 100%;
    padding: 10px 15px;
    border: 1px solid #333;
    border-radius: 5px;
    background-color: var(--background-color);
    color: var(--text-color);
    font-size: 14px;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

.search-input:focus {
    background-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 1px var(--accent-color);
    border-color: var(--accent-color);
}

.help-search-input {
    padding: 10px 15px;
    border: 1px solid #333;
    border-radius: 5px;
    background-color: var(--background-color);
    color: var(--text-color);
    font-size: 14px;
    pointer-events: none;
    user-select: none;
}

.help-search-input:focus {
    outline: none;
}

/* ==============================
   Forms
================================= */
.form-section {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--background-color);
    z-index: 998;
    overflow-y: auto;
    display: flex;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    scrollbar-width: thin;
    scrollbar-color: var(--accent-color) var(--background-color);
}

.form-section::-webkit-scrollbar {
    width: 8px;
}

.form-section::-webkit-scrollbar-track {
    background: var(--background-color);
}

.form-section::-webkit-scrollbar-thumb {
    background-color: var(--accent-color);
    border-radius: 4px;
    border: 2px solid var(--background-color);
}

.form-section.active {
    opacity: 1;
    visibility: visible;
}

.form-content {
    width: 100%;
    max-width: 800px;
    padding: 10px;
    transform: translateY(-20px);
    transition: transform 0.3s ease, opacity 0.3s ease;
    opacity: 0;
    scrollbar-width: thin;
    scrollbar-color: var(--accent-color) var(--background-color);
}

.form-content::-webkit-scrollbar {
    width: 8px;
}

.form-content::-webkit-scrollbar-track {
    background: var(--background-color);
}

.form-content::-webkit-scrollbar-thumb {
    background-color: var(--accent-color);
    border-radius: 4px;
    border: 2px solid var(--background-color);
}

.form-section.active .form-content {
    transform: translateY(0);
    opacity: 1;
    animation: fadeIn 0.5s ease-out;
}

.form-section form {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 2.5px;
}

.form-group label {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: bold;
}

.form-group label svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
    color: var(--accent-color);
}

.form-group input[type="checkbox"] + label {
    cursor: pointer;
}

.form-group input[type="checkbox"] {
    margin-right: 8px;
}

.form-group input,
.form-group textarea,
.form-group select {
    width: 100%;
    padding: 8px;
    border: 1px solid var(--secondary-color);
    border-radius: 4px;
    background-color: var(--primary-color);
    color: var(--text-color);
    font-size: 14px;
    transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
}

.form-group textarea {
    min-height: 150px;
    height: 250px;
    resize: vertical;
}

.form-group input:focus,
.form-group textarea:focus,
.form-group select:focus {
    background-color: #1e588414;
    outline: none;
    box-shadow: 0 0 0 .5px var(--accent-color), inset 0px 0px 20px 0px #0060a559;
    border-color: var(--accent-color);
}

.form-group label[for="equipmentContainer"] {
    display: block;
    margin-top: 10px;
    margin-bottom: 0;
}

#equipmentContainer {
    margin: 0px 0 5px 0;
}

.equipment-item {
    display: flex;
    gap: 10px;
    margin-bottom: 13px;
    align-items: center;
}

.equipment-select,
.psu-for-select,
.equipment-input,
.sn-input {
    flex: 1;
    padding: 10px;
    border: 1px solid #333;
    border-radius: 5px;
    background-color: var(--background-color);
    color: var(--text-color);
    font-size: 14px;
    transition: background-color 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
}

/* Add these new styles */
.equipment-select,
.psu-for-select {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px top 50%;
    background-size: 12px auto;
    padding-right: 30px;
}

.equipment-input,
.sn-input {
    appearance: none;
    background-image: none;
    padding-right: 10px;
}

.equipment-select:focus,
.psu-for-select:focus,
.equipment-input:focus,
.sn-input:focus {
    background-color: var(--primary-color);
    outline: none;
    box-shadow: 0 0 0 1px var(--accent-color);
    border-color: var(--accent-color);
}

/* ==============================
   Tables
================================= */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    font-size: 14px;
}

thead {
    position: sticky;
    top: 0;
    z-index: 2;
    background-color: var(--background-color);
}

th,
td {
    padding: 12px 20px 12px 15px;
    text-align: center;
    border-bottom: 1px solid #444444;
    border-right: 1px solid rgba(68, 68, 68, 0.13);
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
}

th:last-child,
td:last-child {
    border-right: none;
}

th {
    background-color: #333333;
    cursor: pointer;
    position: relative;
    user-select: none;
}

tbody::before {
    content: '';
    display: block;
    height: 2px;
}

th:hover {
    background-color: #2f2f2f;
    border-bottom: .5px solid #ffffff78;
}

th::after {
    content: '';
    position: absolute;
    right: 1px;
    top: 10px;
    border: 6px solid transparent;
    border-top-color: var(--text-color);
    transform: translateY(-50%);
    opacity: 0.6;
    transition: transform 0.2s ease, opacity 0.2s ease, border-color 0.2s ease;
}



th.sorted-asc::after {
    border-bottom-color: var(--accent-color);
    border-top-color: transparent;
    opacity: 1;
}

th.sorted-desc::after {
    border-top-color: var(--accent-color);
    border-bottom-color: transparent;
    opacity: 1;
}

td {
    border-bottom: 1px solid #444444;
}

tr {
    transition: all 0.3s ease;
    position: relative;
}

tr:hover {
    background-color: #0078d40f;
    box-shadow: 0px 0px 1px 1px var(--accent-color), 0 0 10px 0px var(--accent-color);
    z-index: 1;
    cursor: pointer;
}

tr.selected {
    background-color: #0078d42b !important;
}

tr.selected:hover {
    background-color: #0078d42b !important;
}

thead tr:hover {
    box-shadow: none;
    background-color: inherit;
}

.icon-column {
    text-align: center;
    width: 40px;
}

.icon {
    font-size: 18px;
    font-weight: bold;
}

.icon-check {
    color: #4caf50;
}

.icon-x {
    color: #d32f2f;
}

.date-time {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 0.9em;
    white-space: nowrap;
}

.date-time .date {
    font-weight: bold;
}

.date-time .time {
    font-size: 0.9em;
    color: #888;
}

#logCounter {
    font-size: 0.6em;
    color: var(--accent-color);
    vertical-align: super;
    margin-left: 5px;
}

/* ==============================
   Modals
================================= */
/* General Modal Styles */
.modal,
.help-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal {
    background-color: rgba(0, 0, 0, 0.4);
}

.modal-content,
.help-content {
    background-color: var(--primary-color);
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 
                0 1px 3px rgba(0, 0, 0, 0.08);
    border: 1px solid #444;
    max-width: 800px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
}

.help-modal {
    display: none;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
    -webkit-backdrop-filter: blur(2px);
}

.help-modal svg {
    vertical-align: bottom;
}

.help-content {
    background-color: var(--primary-color);
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 
                0 1px 3px rgba(0, 0, 0, 0.08);
    border: 1px solid #444;
    max-width: 700px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
    margin: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--accent-color) var(--background-color);
}

.help-content::-webkit-scrollbar {
    width: 8px;
}

.help-content::-webkit-scrollbar-track {
    background: var(--background-color);
}

.help-content::-webkit-scrollbar-thumb {
    background-color: var(--accent-color);
    border-radius: 4px;
    border: 2px solid var(--background-color);
}

.help-content h2 {
    margin-bottom: 20px;
    color: var(--text-color);
    border-bottom: 2px solid var(--accent-color);
    padding-bottom: 10px;
    font-size: 1.5em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.help-content h3 {
    margin: 20px 0 10px 0;
    color: var(--accent-color);
    font-size: 1.1em;
    display: flex;
    align-items: center;
    gap: 10px;
}

.help-content p,
.help-content li {
    font-size: 0.8em;
    line-height: 1.2;
    margin-bottom: 4px;
}

.help-content ul {
    padding-left: 20px;
    margin-bottom: 6px;
}

.help-content section {
    margin-bottom: 25px;
}
.help-modal strong {
    color: #837769;
    text-shadow: 0 0 3px #0000009c;
}

.close-instruction {
    font-style: italic;
    text-align: center;
    margin-top: 20px;
    color: var(--accent-color);
}

.modal-btn {
    border: none;
    padding: 10px 20px;
    margin: 5px 0;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.3s ease, transform 0.2s ease;
    width: 100%;
}

.modal-btn:hover {
    transform: scale(1.05);
}

/* Close Button for Help Modal */
.close-btn-top {
    position: fixed;
    top: 0px;
    right: 15px;
    background-color: transparent;
    border: none;
    color: var(--text-color);
    font-size: 5em;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.2s ease;
    z-index: 1002;
}

.close-btn-top:hover {
    color: var(--error-color);
    transform: scale(1.2);
}

/* ==============================
   Notifications
================================= */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.notification {
    position: fixed;
    top: 10px;
    left: 0;
    right: 0;
    margin-left: auto;
    margin-right: auto;
    width: fit-content;
    background-color: var(--accent-color);
    color: white;
    padding: 6px 15px;
    border-radius: 5px;
    z-index: 1001;
    transition: opacity 0.3s ease-out;
    text-align: center;
}

.notification.hidden {
    opacity: 0;
    pointer-events: none;
}

/* ==============================
   Utility Classes
================================= */
.checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
}

.replacement-fields {
    display: block;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out, opacity 0.3s ease-out, transform 0.3s ease-out, margin-top 0.3s ease-out, padding 0.3s ease-out;
    opacity: 0;
    transform: translateY(-20px);
    margin-top: 0;
    background-color: transparent;
    padding: 0;
}

.replacement-fields.visible {
    max-height: 1000px; /* Increased max-height */
    opacity: 1;
    transform: translateY(0);
    background-color: var(--primary-color);
    padding: 10px 15px 15px 15px;
    border-radius: 5px;
    box-shadow: -2px -6px 20px rgba(0, 0, 0, 0.25), 
                0 0 0 1px #ffffff40;
    margin-top: 10px;
    margin-bottom: 10px;
}

.replacement-fields .form-group label {
    margin: 7px 0 2px 0;
}

.replacement-fields button {
    padding: 7px 12px;
    box-shadow: inset 0px 0px 1.5px 0.25px #ffffff6b;
}

.button-group {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    align-items: center;
    margin-bottom: 20px;
}


#callForm .button-group button {
    width: 100%;
    border-radius: 5px;
    margin-bottom: -10px;
}




.form-content .button-group button {
   width: calc(100% / 3);
   border-radius: 5px;
   white-space: nowrap;
   overflow: hidden;
   text-overflow: ellipsis;
   margin-bottom: 20px;
}

.form-content .button-group button:first-child {
   width: calc(200% / 3);
}

.help-icon {
    position: fixed;
    top: 15px;
    right: 15px;
    width: 40px;
    height: 40px;
    background-color: var(--primary-color);
    color: var(--text-color);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease, opacity 0.3s ease;
    opacity: 0.5;
    z-index: 997;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

.help-icon svg {
    width: 24px;
    height: 24px;
}

.help-icon:hover {
    background-color: var(--accent-hover-color);
    transform: scale(1.1);
    opacity: 1;
}

/* ==============================
   Options Menu
================================= */
.options-menu {
    position: relative;
    margin-left: -5px;
}

.options-toggle {
    font-size: 24px;
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 5px;
    transition: background-color 0.3s ease;
}

.options-toggle:hover {
    background-color: var(--primary-color);
}

.additional-buttons {
    position: absolute;
    left: -55px;
    top: 140%;
    display: flex;
    flex-direction: column;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
    background-color: var(--background-color);
    border: .5px solid var(--primary-color);
    border-radius: 25px;
    padding: 10px;
    z-index: 10;
    gap: 10px;
    box-shadow: 0px 0px 20px #00000069, 0px 0px 0px 1px #ffffff17;
    pointer-events: none;
}

.options-menu:hover .additional-buttons,
.additional-buttons.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
}

.additional-buttons button {
    white-space: nowrap;
}

.additional-buttons button:last-child {
    margin-bottom: 0;
}

/* ==============================
   Responsive Design
================================= */
@media (max-width: 1070px) {
    .search-input, table { font-size: 14px; }
    th, td { padding: 8px 5px; }
    .form-content { padding: 10px; }
    .form-group input, 
    .form-group textarea, 
    .form-group select { font-size: 14px; }
    /* Hide notes column */
    th:nth-child(8),
    td:nth-child(8) {
        display: none;
    }

}


@media (max-width: 720px) {
    .search-input { font-size: 12px; }
    table { font-size: 12px; }
    th, td { padding: 4px 2px; }
    .form-group input, 
    .form-group textarea, 
    .form-group select { font-size: 12px; }
    /* Further adjust state column for even smaller screens */
    th[data-key="state"], 
    td:nth-child(2) {
        width: 30px;
        min-width: 30px;
        max-width: 30px;
    }
    th::after {
        content: '';
        position: absolute;
        right: -1px;
        top: 6px;
        border: 4px solid transparent;
        border-top-color: var(--text-color);
        transform: translateY(-50%);
        opacity: 0.6;
        transition: transform 0.2s ease, opacity 0.2s ease, border-color 0.2s ease;
    }
}

/* ==============================
   Animations
================================= */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideDown {
    from { max-height: 0; opacity: 0; }
    to { max-height: 500px; opacity: 1; }
}

/* ==============================
   Specific Element Styles
================================= */
input[type="datetime-local"] {
    position: relative;
    cursor: pointer;
}

input[type="datetime-local"]::-webkit-calendar-picker-indicator {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: auto;
    height: auto;
    color: transparent;
    background: transparent;
    cursor: pointer;
}

select {
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http://www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px top 50%;
    background-size: 12px auto;
    padding-right: 30px;
}

/* ==============================
   Miscellaneous Styles
================================= */
#addTestDataBtn {
    display: flex;
}

/* Add or update these styles */
.form-section {
    transition: opacity 0.3s ease;
}

.form-section.active {
    opacity: 1;
}

.form-section:not(.active) {
    opacity: 0;
}

.icon-btn svg {
    vertical-align: middle;
    position: relative;
    top: -1px;
}
.scratch-notes-panel {
    position: fixed;
    top: 0;
    right: -300px;
    width: 300px;
    height: 100%;
    background-color: var(--primary-color);
    box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
    transition: right 0.3s ease;
    z-index: 1000;
    overflow-y: auto;
}

.scratch-notes-panel.open {
    right: 0;
}

.scratch-notes-content {
    padding: 10px 15px 10px 10px;
}

.scratch-notes-content h3 {
   
    color: var(--accent-color);
}

.scratch-note-line {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.copy-line-btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 5px;
    margin-right: 10px;
    color: var(--accent-color);
}

.copy-line-btn:hover {
    color: var(--text-color);
}

.scratch-note-input {
    flex-grow: 1;
    background-color: var(--background-color);
    color: var(--text-color);
    border: 1px solid var(--secondary-color);
    padding: 5px 10px;
    font-size: 10px;
    resize: none;
    overflow: hidden;
    min-height: 24px;
}

.scratch-note-input:focus {
    outline: none;
    border-color: var(--accent-color);
    background-color: #00000026;
}
#scratchNotesBtn{
    background: none;
    color: #FFF;
    border: none;
}
#scratchNotesBtn:hover{
    color: var(--accent-color);
}

/* Add styles for scratch notes header */
.scratch-notes-header {
    position: sticky;
    top: 0;
    background-color: var(--primary-color);
    display: flex;
    flex-direction: column;
    padding: 10px 20px;
    z-index: 1;
    border-bottom: 1px solid var(--secondary-color);
}

.scratch-notes-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 5px;
}

.scratch-notes-hint {
    font-size: 0.5em;
    color: var(--text-color);
    opacity: 0.7;
    line-height: 1.4;
}

#deleteAllScratchNotesBtn {
    background-color: var(--error-color);
    color: var(--text-color);
    border: none;
    padding: 5px 10px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;

}

#deleteAllScratchNotesBtn:hover {
    background-color: var(--error-hover-color);
}

/* Ensure the scratch notes content scrolls beneath the sticky header */
.scratch-notes-content {
    display: flex;
    flex-direction: column;
    height: 100%;
}

#scratchNotesContainer {
    flex-grow: 1;
    overflow-y: auto;
    padding-top: 10px;
}

/* Add this new style for the invisible trigger area */
.scratch-notes-trigger {
    display: none;
}



/* Added styles to ensure consistent styling for opened select on different browsers */
.form-group select {
    background-color: var(--primary-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    cursor: pointer;
}

.form-group select option {
    background-color: var(--primary-color);
}

.form-group select optgroup {
    background-color: var(--primary-color);
}

.replacement-fields.visible .form-group select {
    background-color: var(--background-color);
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-group select::-ms-expand {
    display: none; /* Remove default arrow in Internet Explorer */
}

.replacement-fields.visible  .form-group select option {
    background-color: var(--background-color);
}

.replacement-fields.visible .form-group select optgroup {
    background-color: var(--background-color);
}

/* Add these styles to your existing CSS */
.overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 999;
    display: none;
}

.replacement-fields.visible .form-group input {
    background-color: var(--background-color);
}
.replacement-fields.visible .form-group input:focus {
    background-color: #00091f69;
}

#logsTable tbody tr:nth-child(even) {
    background-color: var(--primary-color);
}

#logsTable tbody tr:nth-child(odd) {
    background-color: var(--background-color);
}

/* Date & Time icon */
.form-group label[for="dateTime"] svg {
    stroke: #4CAF50; /* Green */
}

/* State icon */
.form-group label[for="state"] svg {
    stroke: #2196F3; /* Blue */
}

/* Caller Name icon */
.form-group label[for="callerName"] svg {
    stroke: #FFC107; /* Amber */
}

/* Vendor/Agent ID icon */
.form-group label[for="vendorID"] svg {
    stroke: #9C27B0; /* Purple */
}

/* Vendor/Agent Name icon */
.form-group label[for="vendorName"] svg {
    stroke: #FF5722; /* Deep Orange */
}

/* Phone Number icon */
.form-group label[for="phoneNumber"] svg {
    stroke: #E91E63; /* Pink */
}

/* Ticket/Case # icon */
.form-group label[for="caseNumber"] svg {
    stroke: #00BCD4; /* Cyan */
}

/* Notes icon */
.form-group label[for="notes"] svg {
    stroke: #FF9800; /* Orange */
}

/* Replacement Address icon (if applicable) */
.form-group label[for="replacementAddress"] svg {
    stroke: #8BC34A; /* Light Green */
}

/* Checkbox hover effect */
.checkbox-group input[type="checkbox"] {
    transition: transform 0.2s ease-in-out;
    cursor: pointer;
}

.checkbox-group input[type="checkbox"]:hover {
    transform: scale(1.3);
}

/* Ensure the label also scales for better UX */
.checkbox-group label {
    display: inline-block;
    transition: transform 0.2s ease-in-out;
    cursor: pointer;
}

.checkbox-group label:hover {
    transform: scale(1.05);
}

/* Add these styles to your existing CSS */
.case-number-group {
    display: flex;
    flex-direction: column;
}

.case-number-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
}

.existing-case-checkbox {
    display: flex;
    align-items: center;
    gap: 5px;
    margin-left: 10px;
}

.existing-case-checkbox input[type="checkbox"] {
    margin: 0;
    width: auto;
    transition: transform 0.2s ease-in-out;
    cursor: pointer;
}

.existing-case-checkbox input[type="checkbox"]:hover {
    transform: scale(1.3);
   
}



.existing-case-checkbox label {
    font-size: 0.9em;
    color: var(--text-color);
    text-align: center;
    transition: transform 0.2s ease-in-out;

}

.existing-case-checkbox label:hover{
    transform: scale(1.05);
}

/* Adjust the width of the case number input */
#caseNumber {
    width: calc(100% - 120px); /* Adjust this value as needed */
}

.existing-case-checkbox input:focus{
    box-shadow: none;
}

/* Add this to your existing CSS */
.existing-case {
    color: var(--accent-color);
}
    </style>
</head>
<body>
    <div class="container">
        <div class="main-menu" id="mainMenu">
            <div class="sticky-header">
                <h1>Call Logger</h1>
                <div class="button-group">
                    <button class="create-btn" id="createNewLogBtn">New Call Log</button>
                    <div class="options-menu">
                        <span class="options-toggle">&#8942;</span>
                        <div class="additional-buttons">
                            <button class="export-btn" id="exportLogsBtn">Export Logs</button>
                            <button class="import-btn" id="importLogsBtn">Import Logs</button>
                            <button class="delete-all-btn" id="deleteAllLogsBtn">Delete All Logs</button>
                            <button class="create-btn" id="addTestDataBtn">Add Test Data</button>
                        </div>
                    </div>
                    <button id="scratchNotesBtn" class="icon-btn" title="Scratch Notes">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" accept=".csv" style="display: none;">
                </div>
                <div class="search-bar">
                    <input type="text" id="searchInput" class="search-input" placeholder="Search logs: month/year (ex: 5/23), date (ex: 5/15/23), date range (ex: 5/1/23-5/31/23) or exact phrase (ex: &quot;CA&quot;)">
                </div>
            </div>
            <div class="logs-section">
                <h2>
                    Call Logs <span id="logCounter">(0)</span>
                    <button id="exportFilteredLogsBtn" class="icon-btn" title="Export Filtered Logs">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                </h2>
                <div class="table-container">
                    <table id="logsTable">
                        <thead>
                            <tr>
                                <th data-key="date">Date & Time</th>
                                <th data-key="state">State</th>
                                <th data-key="callerName">Caller Name</th>
                                <th data-key="vendorID">Vendor ID</th>
                                <th data-key="vendorName">Vendor Name</th>
                                <th data-key="phoneNumber">Phone Number</th>
                                <th data-key="caseNumber">Case #</th>
                                <th data-key="notes">Notes</th>
                                <th data-key="status" class="icon-column">Status</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="form-section hidden" id="formSection">
            <div class="form-content">
                <button class="close-btn-top" id="closeFormBtnTop">&times;</button>
                <h2>Call Log Details</h2>
                <form id="callForm">
                    <div class="form-group">
                        <label for="dateTime">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Date & Time
                        </label>
                        <input type="datetime-local" id="dateTime" name="dateTime" required>
                    </div>
                    <div class="form-group">
                        <label for="state">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            State
                        </label>
                        <select id="state" name="state" required>
                            <option value="">Select a state</option>
                            <option value="AB">Alberta (AB)</option>
                            <option value="CA">California (CA)</option>
                            <option value="CO">Colorado (CO)</option>
                            <option value="CT">Connecticut (CT)</option>
                            <option value="MB">Manitoba (MB)</option>
                            <option value="MN">Minnesota (MN)</option>
                            <option value="MS">Mississippi (MS)</option>
                            <option value="NJ">New Jersey (NJ)</option>
                            <option value="SK">Saskatchewan (SK)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="callerName">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Caller Name
                        </label>
                        <input type="text" id="callerName" name="callerName" required>
                    </div>
                    <div class="form-group">
                        <label for="vendorID">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="3" y="4" width="18" height="16" rx="2" ry="2"></rect>
                                <line x1="7" y1="8" x2="17" y2="8"></line>
                                <line x1="7" y1="12" x2="17" y2="12"></line>
                                <line x1="7" y1="16" x2="12" y2="16"></line>
                            </svg>
                            Vendor/Agent ID
                        </label>
                        <input type="text" id="vendorID" name="vendorID" required>
                    </div>
                    <div class="form-group">
                        <label for="vendorName">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            Vendor/Agent Name
                        </label>
                        <input type="text" id="vendorName" name="vendorName" required>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                            Phone Number
                        </label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" required>
                    </div>
                    <div class="form-group case-number-group">
                        <label for="caseNumber">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="22 12 16 12 14 15 10 15 8 12 2 12"></polyline>
                                <path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"></path>
                            </svg>
                            Ticket/Case #
                        </label>
                        <div class="case-number-wrapper">
                            <input type="text" id="caseNumber" name="caseNumber" required>
                            <div class="existing-case-checkbox">
                                <input type="checkbox" id="existingCase" name="existingCase">
                                <label for="existingCase">Existing Ticket</label>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="notes">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Notes
                        </label>
                        <textarea id="notes" name="notes"></textarea>
                    </div>
                    <div class="button-group">
                        <button type="button" id="generateTitleBtn" class="generate-btn">Copy Description</button>
                        <button type="button" id="generateNotesBtn" class="generate-btn">Copy Notes</button>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="replacementCheckbox" name="replacementCheckbox">
                        <label for="replacementCheckbox">
                            Replacement Required
                        </label>
                    </div>
                    <div class="replacement-fields" id="replacementFields">
                        <div class="form-group">
                            <label for="replacementAddress">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                    <circle cx="12" cy="10" r="3"></circle>
                                </svg>
                                Address
                            </label>
                            <input type="text" id="replacementAddress" name="replacementAddress">
                        </div>
                        <div class="form-group">
                            <label>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                    <line x1="8" y1="21" x2="16" y2="21"></line>
                                    <line x1="12" y1="17" x2="12" y2="21"></line>
                                </svg>
                                Equipment
                            </label>
                            <div id="equipmentContainer">
                                <!-- Equipment items will be added here dynamically -->
                            </div>
                            <button type="button" id="addEquipmentBtn" class="add-equipment-btn">Add Equipment</button>
                        </div>
                    </div>
                </form>
                <div class="button-group">
                    <button type="button" class="close-btn" id="closeFormBtn">Close</button>
                    <button type="button" class="create-btn" id="createNewLogFromFormBtn">New Log</button>
                </div>
            </div>
        </div>
    </div>

    <div id="importModal" class="modal hidden">
        <div class="modal-content">
            <h2>Import Logs</h2>
            <p>How would you like to import the logs?</p>
            <div class="button-group">
                <button id="overwriteBtn" class="modal-btn">Overwrite Existing</button>
                <button id="appendBtn" class="modal-btn">Append to Existing</button>
                <button id="cancelImportBtn" class="modal-btn">Cancel</button>
            </div>
        </div>
    </div>

    <div id="notification" class="notification hidden"></div>

    <!-- Move this to the top of the body, just after the opening <body> tag -->
    <div id="helpIcon" class="help-icon">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
        </svg>
    </div>

    <div id="helpModal" class="help-modal">
        <div class="help-content">
            <h2>
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="16" x2="12" y2="12"></line>
                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                </svg>
                Call Logger Help
            </h2>
            
            <section>
                <h3>Quick Start</h3>
                <ul>
                    <li>Click <button class="help-btn create-btn">New Call Log</button> to create a new entry.</li>
                    <li>Use the search bar to filter logs by date, state, or other criteria.</li>
                    <li>Click on a table row to edit a log entry.</li>
                </ul>
            </section>

            <section>
                <h3>Managing Logs</h3>
                <ul>
                    <li><strong>Edit:</strong> Click on any row in the table.</li>
                    <li><strong>Delete:</strong> Use the 
                        <svg class="delete-btn" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                        </svg>
                        to delete a single log.</li>
                    <li><strong>Delete All:</strong> <button class="help-btn delete-all-btn">Delete All Logs</button> to remove all logs.</li>
                    <li><strong>Import:</strong> <button class="help-btn import-btn">Import Logs</button> to upload a CSV file.</li>
                    <li><strong>Export:</strong> <button class="help-btn export-btn">Export Logs</button> to download logs as CSV.</li>
                    <li><strong>Export Filtered:</strong> <button id="exportFilteredLogsBtn" class="icon-btn" title="Export Filtered Logs">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button> to export only filtered logs as CSV.</li>
                </ul>
            </section>

            <section>
                <h3>Search Tips</h3>
                <ul>
                    <li><strong>Date formats:</strong>
                        <ul>
                            <li>Month/Year: "MM/YYYY" or "MM/YY"</li>
                            <li>Specific Date: "MM/DD/YYYY" or "MM/DD/YY"</li>
                            <li>Date Range: "MM/DD/YYYY-MM/DD/YYYY"</li>
                        </ul>
                    </li>
                    <li><strong>State:</strong> Enter state abbreviation (e.g., "CA")</li>
                    <li><strong>Exact phrase:</strong> Use quotes (e.g., "John Doe")</li>
                    <li><strong>Existing Tickets:</strong> Search "existing ticket" to display all existing tickets call logs.</li>
                </ul>
            </section>

            <section>
                <h3>Form Features</h3>
                <ul>
                    <li><strong>Auto-save:</strong> Changes are saved as you type to the local storage of your browser.</li>
                    <li><strong>Generate buttons:</strong>
                        <ul>
                            <li><button class="help-btn generate-btn">Copy Description</button> Copies <b style="font-family: monospace; letter-spacing: -.05em; color: #ffe304cc">"(State)-(Vendor ID)-(First Sentence of Notes)"</b> to clipboard.</li>
                            <li><button class="help-btn generate-btn">Copy Notes</button> Copies <b style="font-family: monospace; letter-spacing: -.05em; color: #ffe304cc">"(Caller Name) called in with (Notes)"</b> to clipboard.</li>
                        </ul>
                    </li>
                    <li><strong>Existing Case Checkbox:</strong> Mark a ticket as an "existing case" if call is regarding an already open ticket. Ticket will appear in <span style="color:var(--accent-color);">blue</span> in the table.</li>
                    <li><strong>Replacement Required Checkbox:</strong> When checked, it automatically generates a replacement template in the notes field:
                        <ul>
                            <br>
                            <li style="margin-bottom:6px;"><b>Request Reason:</b> Due to [reason]</li>
                            <li><b>Item List:</b>
                                <ul>
                                    <li>1 x [Equipment Name]</li>
                                </ul>
                            </li>
                            <li style="margin-bottom:6px;"><b>Shipping Address:</b>
                                <br>
                                [Vendor Name]
                                <br>
                                [Street Address]
                                <br>
                                [City, State ZIP]
                            </li>
                            <li><b>Case #:</b> [Case Number]</li>
                            <li><b>SN:</b> [Serial Numbers]</li>
                            <li><b>TID:</b> [Terminal ID]</li>
                            <br>
                        </ul>
                    </li>
                    <li><strong>Shortcut:</strong> Press <u>ESC</u> to close the current form or modal.</li>
                </ul>
            </section>

            <section>
                <h3>Scratch Notes</h3>
                <p>Access scratch notes by clicking the 
                    <svg id="scratchNotesBtn" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    icon.</p>
                <ul>
                    <li>Add new notes by typing in the input fields.</li>
                    <li>Copy note content using the copy icon.</li>
                    <li>Use "Delete All" to clear all scratch notes.</li>
                    <li>Press <b>Enter</b> for a new note, <b>Shift+Enter</b> for a new line in the same note.</li>
                </ul>
            </section>

            <p class="close-instruction">Click anywhere outside this box to close the help.</p>
        </div>
    </div>
    <div class="scratch-notes-trigger"></div>

    <div id="scratchNotesPanel" class="scratch-notes-panel">
        <div class="scratch-notes-content">
            <!-- Add Scratch Notes header with Delete All button -->
            <div class="scratch-notes-header">
                <div class="scratch-notes-header-top">
                    <h3>Scratch Notes</h3>
                    <button id="deleteAllScratchNotesBtn">Delete All</button>
                </div>
                <div class="scratch-notes-hint">
                    Press <b>Enter</b> for a new note<br>
                    Press <b>Shift+Enter</b> for a new line in the same note<br>
                </div>
            </div>
            <div id="scratchNotesContainer"></div>
        </div>
    </div>

    <!-- Add this div just before the closing </body> tag -->
    <div id="overlay" class="overlay"></div>

<script>

const utils = {
    formatDateTimeLocal(date) {
        const d = new Date(date);
        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
        return d.toISOString().slice(0, 16);
    },
    formatPhoneNumber(phoneNumber) {
        const cleaned = phoneNumber.replace(/\D/g, '');
        if (cleaned.length <= 3) return cleaned;
        if (cleaned.length <= 6) return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3)}`;
        return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
    },
    parseDate(dateString) {
        const [month, day, year] = dateString.split('/');
        const fullYear = year.length === 2 ? `20${year}` : year;
        return new Date(fullYear, month - 1, day);
    },
    serializeEquipment(equipment) {
        return equipment?.map(item => {
            return item.name === 'PSU' && item.psuFor
                ? `${item.name}|${item.serialNumber}|${item.psuFor}`
                : `${item.name}|${item.serialNumber}`;
        }).join(';') || '';
    },
    deserializeEquipment(equipmentString) {
        return equipmentString?.split(';').map(item => {
            const parts = item.split('|');
            return parts.length === 3 && parts[0] === 'PSU'
                ? { name: parts[0], serialNumber: parts[1], psuFor: parts[2] }
                : { name: parts[0], serialNumber: parts[1] };
        }) || [];
    },
    showNotification: (() => {
        let activeNotification = null;
        let timeout;

        return (message, duration = 1500) => {
            const notification = document.getElementById('notification');
            
            // Clear any existing timeout
            clearTimeout(timeout);
            
            // If there's an active notification, remove it immediately
            if (activeNotification) {
                notification.classList.add('hidden');
                notification.style.animation = 'none';
                notification.offsetHeight; // Trigger reflow
            }
            
            // Set up the new notification
            notification.textContent = message;
            notification.classList.remove('hidden');
            notification.style.animation = 'fadeIn 0.3s ease-out';
            
            // Set the active notification
            activeNotification = notification;
            
            // Set up the timeout to hide the notification
            timeout = setTimeout(() => {
                notification.classList.add('hidden');
                activeNotification = null;
            }, duration);
        };
    })()
};

// Storage Handling
const storage = {
    getLogs() {
        const logs = localStorage.getItem('callLogs');
        return logs ? JSON.parse(logs) : [];
    },
    saveLogs(logs) {
        localStorage.setItem('callLogs', JSON.stringify(logs));
    },
    getCurrentSort() {
        return JSON.parse(localStorage.getItem('currentSort')) || { key: 'date', order: 'desc' };
    },
    saveCurrentSort(sort) {
        localStorage.setItem('currentSort', JSON.stringify(sort));
    }
};

// Renderer
const renderer = {
    renderLogs(sortKey = 'date', sortOrder = 'desc', logs = storage.getLogs()) {
        const sortedLogs = [...logs].sort((a, b) => {
            if (sortKey === 'date') {
                return sortOrder === 'desc'
                    ? new Date(b.date) - new Date(a.date)
                    : new Date(a.date) - new Date(b.date);
            }
            const valA = (a[sortKey] || '').toString().toLowerCase();
            const valB = (b[sortKey] || '').toString().toLowerCase();
            if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
            if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });

        app.currentFilteredLogs = sortedLogs;
        this.renderFilteredLogs(sortedLogs);
    },
    renderFilteredLogs(filteredLogs) {
        const tbody = document.querySelector('#logsTable tbody');
        tbody.innerHTML = filteredLogs.map(log => {
            const date = new Date(log.date);
            const formattedDate = date.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' });
            const formattedTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
            const caseNumberClass = log.existingCase ? 'existing-case' : '';
            return `
                <tr data-id="${log.id}">
                    <td>
                        <div class="date-time">
                            <div class="date">${formattedDate}</div>
                            <div class="time">${formattedTime}</div>
                        </div>
                    </td>
                    <td>${log.state}</td>
                    <td>${log.callerName}</td>
                    <td>${log.vendorID}</td>
                    <td>${log.vendorName}</td>
                    <td>${log.phoneNumber}</td>
                    <td class="${caseNumberClass}">${log.caseNumber}</td>
                    <td>${log.notes}</td>
                    <td class="icon-column">
                        <span class="icon ${log.caseNumber ? 'icon-check' : 'icon-x'}">
                            ${log.caseNumber ? '' : ''}
                        </span>
                    </td>
                    <td>
                        <svg class="delete-btn" data-id="${log.id}" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                        </svg>
                    </td>
                </tr>
            `;
        }).join('');
        document.getElementById('logCounter').textContent = `(${filteredLogs.length})`;
    },
    renderNewLog(log) {
        const tbody = document.querySelector('#logsTable tbody');
        const rowHTML = `
            <tr data-id="${log.id}">
                <td>
                    <div class="date-time">
                        <div class="date">${new Date(log.date).toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' })}</div>
                        <div class="time">${new Date(log.date).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}</div>
                    </div>
                </td>
                <td>${log.state}</td>
                <td>${log.callerName}</td>
                <td>${log.vendorID}</td>
                <td>${log.vendorName}</td>
                <td>${log.phoneNumber}</td>
                <td>${log.caseNumber}</td>
                <td>${log.notes}</td>
                <td class="icon-column">
                    <span class="icon ${log.caseNumber ? 'icon-check' : 'icon-x'}">
                        ${log.caseNumber ? '' : ''}
                    </span>
                </td>
                <td>
                    <svg class="delete-btn" data-id="${log.id}" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" fill="currentColor"/>
                    </svg>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('afterbegin', rowHTML);
    }
};

// Equipment Handling
const equipmentHandler = {
    predefinedEquipment: [
        { category: "Printers", items: ["Zebra Printer", "Datamax E4203 Printer", "Datamax E4205A Printer", "Citizen CT-S2000 Printer"] },
        { category: "Terminals", items: ["RP2 Terminal", "MP9 Terminal", "Engage One Terminal", "Flex Mini Terminal", "Omni 3740 Terminal"] },
        { category: "Cables", items: ["USB Printer Cable", "VGA Cable", "9pin to 9pin Cable", "Ethernet Cable"] },
        { category: "Other", items: ["PSU", "License Paper", "Receipt Paper", "Signature Pad", "USB Reimage Key"] }
    ],
    createEquipmentItem(item = null) {
        const equipmentItem = document.createElement('div');
        equipmentItem.className = 'equipment-item';
        equipmentItem.innerHTML = `
            <select class="equipment-select">
                <option value="">Select Equipment</option>
                ${this.predefinedEquipment.map(category => `
                    <optgroup label="${category.category}">
                        ${category.items.map(e => `<option value="${e}">${e}</option>`).join('')}
                    </optgroup>
                `).join('')}
                <option value="custom">Custom</option>
            </select>
            <select class="psu-for-select" style="display: none;">
                <option value="">PSU for...</option>
                ${this.predefinedEquipment
                    .filter(cat => ['Printers', 'Terminals'].includes(cat.category))
                    .flatMap(cat => cat.items)
                    .map(item => `<option value="${item}">${item}</option>`)
                    .join('')}
            </select>
            <input type="text" class="equipment-input" placeholder="Custom Equipment" style="display: none;">
            <input type="text" class="sn-input" placeholder="Serial Number">
            <button type="button" class="remove-equipment-btn">Remove</button>
        `;

        const select = equipmentItem.querySelector('.equipment-select');
        const psuForSelect = equipmentItem.querySelector('.psu-for-select');
        const input = equipmentItem.querySelector('.equipment-input');
        const snInput = equipmentItem.querySelector('.sn-input');

        if (item) {
            const isPredefined = this.predefinedEquipment.some(cat => cat.items.includes(item.name));
            if (isPredefined) {
                select.value = item.name;
                if (item.name === 'PSU') {
                    psuForSelect.style.display = 'inline-block';
                    psuForSelect.value = item.psuFor || '';
                }
            } else {
                select.value = 'custom';
                select.dispatchEvent(new Event('change'));
                input.value = item.name;
            }
            snInput.value = item.serialNumber || '';
        }

        select.addEventListener('change', () => {
            if (select.value === "custom") {
                select.style.display = 'none';
                input.style.display = 'inline-block';
                input.value = '';
                psuForSelect.style.display = 'none';
            } else if (select.value === "PSU") {
                input.style.display = 'none';
                psuForSelect.style.display = 'inline-block';
            } else {
                input.style.display = 'none';
                psuForSelect.style.display = 'none';
            }
            app.autoSave({ target: select });
        });

        psuForSelect.addEventListener('change', () => app.autoSave({ target: psuForSelect }));
        input.addEventListener('input', () => app.autoSave({ target: input }));
        snInput.addEventListener('input', () => app.autoSave({ target: snInput }));

        return equipmentItem;
    },
    addEquipment() {
        const container = document.getElementById('equipmentContainer');
        container.appendChild(this.createEquipmentItem());
        this.updateLogEquipment();
    },
    removeEquipment(event) {
        if (event.target.classList.contains('remove-equipment-btn')) {
            event.target.closest('.equipment-item').remove();
            this.updateLogEquipment();
            app.updateNotesWithAddressAndEquipment(); // Add this line
        }
    },
    updateLogEquipment() {
        const logs = storage.getLogs();
        const logIndex = logs.findIndex(log => log.id === app.currentEditId);
        if (logIndex !== -1) {
            logs[logIndex].equipment = this.getEquipmentData();
            storage.saveLogs(logs);
            renderer.renderLogs(app.currentSort.key, app.currentSort.order);
            app.updateNotesWithAddressAndEquipment(); // Add this line
        }
    },
    getEquipmentData() {
        return Array.from(document.querySelectorAll('.equipment-item')).map(item => {
            const select = item.querySelector('.equipment-select');
            const psuForSelect = item.querySelector('.psu-for-select');
            const input = item.querySelector('.equipment-input');
            const snInput = item.querySelector('.sn-input');
            const equipmentName = select.value === 'custom' ? input.value : select.value;
            return {
                name: equipmentName,
                serialNumber: snInput.value,
                ...(equipmentName === 'PSU' && { psuFor: psuForSelect.value })
            };
        });
    }
};

// Import/Export Handling
const importExportHandler = {
    handleExportLogs() {
        const logs = storage.getLogs();
        if (!logs.length) {
            alert('No logs to export.');
            return;
        }

        const headers = ['Date & Time', 'State', 'Caller Name', 'Phone Number', 'Vendor Name', 'Vendor ID', 'Case #', 'Existing Ticket', 'Notes', 'Replacement', 'Equipment', 'Address'];
        const csvContent = [
            headers.join(','),
            ...logs.map(log => [
                `"${new Date(log.date).toLocaleString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}"`,
                `"${log.state}"`,
                `"${log.callerName}"`,
                `"${log.phoneNumber}"`,
                `"${log.vendorName}"`,
                `"${log.vendorID}"`,
                `"${log.caseNumber}"`,
                log.existingCase ? 'Yes' : 'No',
                `"${log.notes.replace(/"/g, '""')}"`,
                log.replacement ? 'Yes' : 'No',
                `"${utils.serializeEquipment(log.equipment)}"`,
                `"${log.replacementAddress || ''}"`
            ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;

        const now = new Date();
        const dateTimeStamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
        link.download = `call_logs_${dateTimeStamp}.csv`;
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Add this line at the end of the function
        app.toggleExportFilteredLogsBtn(false);
    },
    handleImportLogs(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = e => {
            const content = e.target.result;
            const lines = content.split('\n');
            const headers = lines[0].split(',');

            if (!this.validateCSVStructure(headers)) {
                alert('Invalid CSV structure. Please make sure the file matches the expected format.');
                return;
            }

            const importedLogs = [];
            let currentEntry = '';
            let isInQuotes = false;

            for (let i = 1; i < lines.length; i++) {
                let line = lines[i];
                
                if (!line.trim() && !isInQuotes) continue; // Skip empty lines outside of quotes

                const quoteCount = (line.match(/"/g) || []).length;
                isInQuotes = isInQuotes ? !(quoteCount % 2 === 1) : (quoteCount % 2 === 1);

                currentEntry += (currentEntry ? '\n' : '') + line;

                if (!isInQuotes && currentEntry.trim()) {
                    // Process the complete entry
                    this.processLogEntry(currentEntry, importedLogs);
                    currentEntry = '';
                }
            }

            // Process any remaining entry
            if (currentEntry.trim()) {
                this.processLogEntry(currentEntry, importedLogs);
            }

            const existingLogs = storage.getLogs();
            if (existingLogs.length) {
                app.importedLogs = importedLogs;
                this.showImportModal();
            } else {
                storage.saveLogs(importedLogs);
                renderer.renderLogs(storage.getCurrentSort().key, storage.getCurrentSort().order);
                utils.showNotification('Logs imported successfully!');
            }

            event.target.value = '';
        };
        reader.readAsText(file);
    },

    processLogEntry(entry, importedLogs) {
        const fields = entry.match(/("([^"]|"")*"|[^,]*)(,|$)/g);
        if (!fields || fields.length < 12) {  // Changed from 11 to 12 to include Existing Case
            console.error('Invalid entry:', entry);
            return;
        }

        const values = fields.map(field => {
            field = field.trim();
            if (field.endsWith(',')) field = field.slice(0, -1);
            return field.replace(/^"|"$/g, '').replace(/""/g, '"').trim();
        });

        const date = new Date(values[0]);

        if (isNaN(date.getTime())) {
            console.error('Invalid date:', values[0]);
            return;
        }

        try {
            const log = {
                id: Date.now() + Math.floor(Math.random() * 1e6),
                date: date.toISOString(),
                state: values[1],
                callerName: values[2],
                phoneNumber: values[3],
                vendorName: values[4],
                vendorID: values[5],
                caseNumber: values[6],
                existingCase: values[7].toLowerCase() === 'yes',
                notes: values[8],
                replacement: values[9].toLowerCase() === 'yes',
                equipment: utils.deserializeEquipment(values[10]),
                replacementAddress: values[11] || ''
            };
            importedLogs.push(log);
        } catch (error) {
            console.error('Error creating log object:', error);
        }
    },

    validateCSVStructure(headers) {
        const expected = ['Date & Time', 'State', 'Caller Name', 'Phone Number', 'Vendor Name', 'Vendor ID', 'Case #', 'Existing Ticket', 'Notes', 'Replacement', 'Equipment', 'Address'];
        return JSON.stringify(headers) === JSON.stringify(expected);
    },
    overwriteLogs() {
        storage.saveLogs(app.importedLogs);
        renderer.renderLogs(storage.getCurrentSort().key, storage.getCurrentSort().order);
        utils.showNotification('Logs overwritten successfully!');
        this.resetImportState();
        this.hideImportModal();
        app.toggleExportFilteredLogsBtn(false);
    },
    appendLogs() {
        const existingLogs = storage.getLogs();
        storage.saveLogs([...existingLogs, ...app.importedLogs]);
        renderer.renderLogs(storage.getCurrentSort().key, storage.getCurrentSort().order);
        utils.showNotification('Logs appended successfully!');
        this.resetImportState();
        this.hideImportModal();
        app.toggleExportFilteredLogsBtn(false);
    },
    resetImportState() {
        app.importedLogs = [];
        document.getElementById('fileInput').value = '';
    },
    showImportModal() {
        document.getElementById('importModal').classList.remove('hidden');
    },
    hideImportModal() {
        document.getElementById('importModal').classList.add('hidden');
    },
    exportFilteredLogs() {
        const filteredLogs = app.currentFilteredLogs;
        if (!filteredLogs.length) {
            alert('No logs to export.');
            return;
        }

        const headers = ['Date & Time', 'State', 'Caller Name', 'Phone Number', 'Vendor Name', 'Vendor ID', 'Case #', 'Existing Ticket', 'Notes', 'Replacement', 'Equipment', 'Address'];
        const csvContent = [
            headers.join(','),
            ...filteredLogs.map(log => [
                `"${new Date(log.date).toLocaleString('en-US', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' })}"`,
                `"${log.state}"`,
                `"${log.callerName}"`,
                `"${log.phoneNumber}"`,
                `"${log.vendorName}"`,
                `"${log.vendorID}"`,
                `"${log.caseNumber}"`,
                log.existingCase ? 'Yes' : 'No',
                `"${log.notes.replace(/"/g, '""')}"`,
                log.replacement ? 'Yes' : 'No',
                `"${utils.serializeEquipment(log.equipment)}"`,
                `"${log.replacementAddress || ''}"`
            ].join(','))
        ].join('\n');

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;

        const now = new Date();
        const dateTimeStamp = now.toISOString().replace(/[:.]/g, '-').slice(0, 19);
        link.download = `filtered_call_logs_${dateTimeStamp}.csv`;
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
};

// Form Handling
const formHandler = {
    clearForm() {
        document.getElementById('callForm').reset();
        document.getElementById('replacementFields').classList.remove('visible');
        document.getElementById('equipmentContainer').innerHTML = '';
    },
    populateForm(log) {
        document.getElementById('dateTime').value = utils.formatDateTimeLocal(log.date);
        document.getElementById('state').value = log.state || '';
        document.getElementById('callerName').value = log.callerName;
        document.getElementById('phoneNumber').value = log.phoneNumber;
        document.getElementById('vendorName').value = log.vendorName;
        document.getElementById('vendorID').value = log.vendorID;
        document.getElementById('caseNumber').value = log.caseNumber;
        document.getElementById('existingCase').checked = log.existingCase || false;
        document.getElementById('notes').value = log.notes;
        document.getElementById('replacementCheckbox').checked = log.replacement;
        document.getElementById('replacementFields').classList.toggle('visible', log.replacement);
        document.getElementById('replacementAddress').value = log.replacementAddress || '';

        const equipmentContainer = document.getElementById('equipmentContainer');
        equipmentContainer.innerHTML = '';
        log.equipment?.forEach(item => equipmentContainer.appendChild(equipmentHandler.createEquipmentItem(item)));

        // Move this call after setting the checkbox
        app.updateNotesWithAddressAndEquipment();
    },
    handleCreateNewLog() {
        this.clearForm();
        const newLog = {
            id: Date.now(),
            date: new Date().toISOString(),
            state: '',
            callerName: '',
            phoneNumber: '',
            vendorName: '',
            vendorID: '',
            caseNumber: '',
            notes: '',
            replacement: false,
            equipment: []
        };
        const logs = storage.getLogs();
        logs.push(newLog);
        storage.saveLogs(logs);
        app.currentEditId = newLog.id;
        app.currentlySelectedLogId = newLog.id;
        this.showForm();
        this.populateForm(newLog);
        document.getElementById('dateTime').value = utils.formatDateTimeLocal(new Date());
        app.updateSelectedRow();
        utils.showNotification('New log created successfully!');
    },
    showForm() {
        const mainMenu = document.getElementById('mainMenu');
        const formSection = document.getElementById('formSection');
        mainMenu.classList.add('fade-out');
        setTimeout(() => {
            mainMenu.classList.add('hidden');
            formSection.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            formSection.offsetHeight;
            formSection.classList.add('active');
        }, 200);
    },
    hideForm() {
        const mainMenu = document.getElementById('mainMenu');
        const formSection = document.getElementById('formSection');
        formSection.classList.remove('active');
        setTimeout(() => {
            formSection.classList.add('hidden');
            mainMenu.classList.remove('hidden');
            mainMenu.offsetHeight;
            mainMenu.classList.remove('fade-out');
            document.body.style.overflow = '';
            renderer.renderLogs(storage.getCurrentSort().key, storage.getCurrentSort().order);
            app.updateSelectedRow();
            app.currentEditId = null;
        }, 200);
    },
    handleFormSubmit(event) {
        event.preventDefault();
        const logs = storage.getLogs();
        const form = document.getElementById('callForm');
        const formData = new FormData(form);
        const log = {
            id: app.currentEditId || Date.now(),
            date: new Date(formData.get('dateTime')).toISOString(),
            state: formData.get('state') || '',
            callerName: formData.get('callerName'),
            phoneNumber: formData.get('phoneNumber'),
            vendorName: formData.get('vendorName'),
            vendorID: formData.get('vendorID'),
            caseNumber: formData.get('caseNumber'),
            existingCase: formData.get('existingCase') === 'on',
            notes: formData.get('notes'),
            replacement: formData.get('replacementCheckbox') === 'on',
            equipment: equipmentHandler.getEquipmentData(),
            replacementAddress: formData.get('replacementAddress') || ''
        };

        if (app.currentEditId) {
            const index = logs.findIndex(l => l.id === app.currentEditId);
            if (index !== -1) logs[index] = log;
        } else {
            logs.push(log);
        }

        storage.saveLogs(logs);
        renderer.renderLogs(storage.getCurrentSort().key, storage.getCurrentSort().order);
        this.hideForm();
    },
    generateTestData(count = 100) {
        const vendors = ['Walmart', 'Target', 'Bass Pro Shops', 'Cabela\'s', 'REI', 'Dick\'s Sporting Goods', 'Academy Sports + Outdoors', 'Big 5 Sporting Goods', 'Sportsman\'s Warehouse', 'Scheels'];
        const states = ['AB', 'CA', 'CO', 'MB', 'MN', 'MS', 'NJ', 'SK'];
        const equipmentTypes = [
            { category: "Printers", items: ["Zebra Printer", "Datamax E4203 Printer", "Datamax E4205A Printer", "Citizen CT-S2000 Printer"] },
            { category: "Terminals", items: ["RP2 Terminal", "MP9 Terminal", "Engage One Terminal", "Flex Mini Terminal", "Omni 3740 Terminal"] },
            { category: "Cables", items: ["USB Printer Cable", "VGA Cable", "9pin to 9pin Cable", "Ethernet Cable"] },
            { category: "Other", items: ["PSU", "License Paper", "Receipt Paper", "Signature Pad", "USB Reimage Key"] }
        ];
        const firstNames = ['John', 'Jane', 'Michael', 'Emily', 'David', 'Sarah', 'Robert', 'Jennifer', 'William', 'Elizabeth', 'James', 'Linda', 'Richard', 'Patricia', 'Thomas', 'Barbara', 'Charles', 'Margaret', 'Joseph', 'Susan'];
        const lastNames = ['Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis', 'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas', 'Taylor', 'Moore', 'Jackson', 'Martin'];
        const startDate = new Date(2022, 0, 1);
        const endDate = new Date();

        const generateRandomNumber = length => Array.from({ length }, () => Math.floor(Math.random() * 10)).join('');
        const getRandomName = () => `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)]}`;

        return Array.from({ length: count }, (_, i) => {
            const date = new Date(startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime()));
            const replacement = Math.random() < 0.3;
            const hasCaseNumber = Math.random() < 0.8;
            const equipmentCount = replacement ? Math.floor(Math.random() * 3) + 1 : 0;
            const equipment = Array.from({ length: equipmentCount }, () => {
                const category = equipmentTypes[Math.floor(Math.random() * equipmentTypes.length)];
                const item = category.items[Math.floor(Math.random() * category.items.length)];
                if (item === 'PSU') {
                    const psuFor = equipmentTypes[1].items[Math.floor(Math.random() * equipmentTypes[1].items.length)];
                    return { name: item, serialNumber: `SN${generateRandomNumber(6)}`, psuFor };
                }
                return { name: item, serialNumber: `SN${generateRandomNumber(6)}` };
            });

            const state = states[Math.floor(Math.random() * states.length)];
            let vendorId, caseNumber;

            const generateVendorAndCase = () => {
                switch (state) {
                    case 'CA':
                        vendorId = `${generateRandomNumber(6)}-${generateRandomNumber(3)}`;
                        caseNumber = hasCaseNumber ? generateRandomNumber(6) : '';
                        break;
                    case 'NJ':
                        vendorId = `${generateRandomNumber(6)}-${generateRandomNumber(3)}`;
                        caseNumber = hasCaseNumber ? `CS${generateRandomNumber(6)}` : '';
                        break;
                    case 'CO':
                    case 'MB':
                    case 'AB':
                        vendorId = generateRandomNumber(4);
                        caseNumber = hasCaseNumber ? `CS0${generateRandomNumber(6)}` : '';
                        break;
                    case 'MN':
                        vendorId = generateRandomNumber(5);
                        caseNumber = hasCaseNumber ? `CS0${generateRandomNumber(6)}` : '';
                        break;
                    default:
                        vendorId = generateRandomNumber(7);
                        caseNumber = hasCaseNumber ? `CS0${generateRandomNumber(6)}` : '';
                }
            };
            generateVendorAndCase();

            return {
                id: Date.now() + i,
                date: date.toISOString(),
                state,
                callerName: getRandomName(),
                phoneNumber: `(${generateRandomNumber(3)}) ${generateRandomNumber(3)}-${generateRandomNumber(4)}`,
                vendorName: `${vendors[Math.floor(Math.random() * vendors.length)]} #${generateRandomNumber(4)}`,
                vendorID: vendorId,
                caseNumber,
                existingCase: Math.random() < 0.3, // 30% chance of being an existing case
                notes: `Call log ${i + 1}. ${replacement ? 'Equipment replacement required.' : 'Routine maintenance call.'} ${hasCaseNumber ? 'Case number assigned.' : 'Awaiting case number.'}`,
                replacement,
                equipment,
                replacementAddress: replacement
                    ? `${generateRandomNumber(3)} ${lastNames[Math.floor(Math.random() * lastNames.length)]} St, ${lastNames[Math.floor(Math.random() * lastNames.length)]} City, ${state} ${generateRandomNumber(5)}`
                    : ''
            };
        });
    }
};

// Main Application
const app = {
    currentEditId: null,
    currentlySelectedLogId: null,
    currentSort: storage.getCurrentSort(),
    currentFilteredLogs: [],
    importedLogs: [],
    autoSave(event) {
        const { target } = event;
        const name = target.name;
        let value = target.type === 'checkbox' ? target.checked : target.value;

        if (name === 'phoneNumber') {
            value = utils.formatPhoneNumber(value);
            target.value = value;
        }

        const logs = storage.getLogs();
        const logIndex = logs.findIndex(log => log.id === this.currentEditId);

        if (logIndex !== -1) {
            if (name) {
                if (name === 'replacementCheckbox' || name === 'existingCase') {
                    logs[logIndex][name === 'replacementCheckbox' ? 'replacement' : 'existingCase'] = value;
                    if (name === 'replacementCheckbox') {
                        document.getElementById('replacementFields').classList.toggle('visible', value);
                        if (value) {
                            setTimeout(() => {
                                this.scrollToBottom();
                            }, 250);
                        }
                    }
                    this.updateNotesWithAddressAndEquipment();
                } else {
                    logs[logIndex][name] = value;
                }
            }

            if (name === 'replacementCheckbox' || target.closest('.equipment-item') || target.id === 'equipmentContainer' || name === 'replacementAddress' || name === 'vendorName' || name === 'vendorID' || name === 'caseNumber') {
                logs[logIndex].equipment = equipmentHandler.getEquipmentData();
                this.updateNotesWithAddressAndEquipment();
            }

            storage.saveLogs(logs);
            renderer.renderLogs(this.currentSort.key, this.currentSort.order);
        }
    },
    updateNotesWithAddressAndEquipment() {
        const notesField = document.getElementById('notes');
        const addressField = document.getElementById('replacementAddress');
        const vendorNameField = document.getElementById('vendorName');
        const vendorIDField = document.getElementById('vendorID');
        const caseNumberField = document.getElementById('caseNumber');
        const replacementCheckbox = document.getElementById('replacementCheckbox');
        const equipment = equipmentHandler.getEquipmentData();

        // Split the existing notes
        let [existingNotes, generatedContent] = notesField.value.split('\n---------------\n');
        existingNotes = existingNotes.trim();

        // Extract "Due to" information if it exists
        let dueTo = '';
        if (generatedContent) {
            const dueToMatch = generatedContent.match(/Request Reason:\nDue to([\s\S]*?)(?=\n\nItem List:|\n\nShipping Address:|\n\nCase #:)/);
            if (dueToMatch) {
                dueTo = dueToMatch[1].trim();
            }
        }

        // If replacement is not required, remove generated content and return
        if (!replacementCheckbox.checked) {
            notesField.value = existingNotes;
            this.autoSave({ target: notesField });
            return;
        }

        let additionalNotes = '\n\n---------------\n\n';

        // Always include the "Due to" section
        additionalNotes += `Request Reason:\nDue to ${dueTo}\n\n`;

        // Only include Item List if there's equipment
        if (equipment.length > 0) {
            additionalNotes += 'Item List:\n';
            equipment.forEach(item => {
                if (item.name === 'PSU' && item.psuFor) {
                    additionalNotes += `1 x PSU ${item.psuFor}\n`;
                } else if (item.name === 'USB Reimage Key') {
                    const state = document.getElementById('state').value;
                    additionalNotes += `1 x ${state} reimage key\n`;
                } else {
                    additionalNotes += `1 x ${item.name}\n`;
                }
            });
            additionalNotes += '\n';
        }

        // Only include Shipping Address if there's an address
        if (addressField.value) {
            const [street, cityStateZip] = this.formatAddress(addressField.value);
            additionalNotes += 'Shipping Address:\n';
            additionalNotes += `${vendorNameField.value}\n`;
            additionalNotes += `${street}\n`;
            additionalNotes += `${cityStateZip}\n\n`;
        }

        // Always include Case #, SN, and TID
        additionalNotes += `Case #: ${caseNumberField.value}\n`;

        const serialNumbers = equipment
            .map(item => item.serialNumber)
            .filter(sn => sn)
            .join(', ');
        additionalNotes += `SN: ${serialNumbers}\n`;

        additionalNotes += `TID: ${vendorIDField.value}`;

        // Combine the existing notes with the new additional notes
        notesField.value = existingNotes + additionalNotes;

        // Trigger the autoSave for the notes field
        this.autoSave({ target: notesField });
    },
    formatAddress(address) {
        const parts = address.split(',');
        if (parts.length > 1) {
            const street = parts[0].trim();
            const cityStateZip = parts.slice(1).join(',').trim();
            return [street, cityStateZip];
        }
        return [address, ''];
    },
    handleEdit(logId) {
        const logs = storage.getLogs();
        const log = logs.find(l => l.id === parseInt(logId));
        if (!log) return;
        this.currentEditId = log.id;
        formHandler.showForm();
        formHandler.populateForm(log);
    },
    handleDelete(logId) {
        if (confirm('Are you sure you want to delete this call log?')) {
            let logs = storage.getLogs().filter(log => log.id !== parseInt(logId));
            storage.saveLogs(logs);
            renderer.renderLogs(this.currentSort.key, this.currentSort.order);
            utils.showNotification('Log deleted successfully!');
        }
    },
    handleSort(event) {
        const th = event.target.closest('th');
        if (!th?.dataset.key) return;

        const sortKey = th.dataset.key;
        let sortOrder = 'asc';

        if (this.currentSort.key === sortKey) {
            sortOrder = this.currentSort.order === 'asc' ? 'desc' : 'asc';
        }

        this.currentSort = { key: sortKey, order: sortOrder };
        storage.saveCurrentSort(this.currentSort);

        document.querySelectorAll('#logsTable th').forEach(header => header.classList.remove('sorted-asc', 'sorted-desc'));
        th.classList.add(`sorted-${sortOrder}`);

        this.currentFilteredLogs.sort((a, b) => {
            let valA = sortKey === 'status' ? (a.caseNumber ? 1 : 0) : (a[sortKey] || '').toString().toLowerCase();
            let valB = sortKey === 'status' ? (b.caseNumber ? 1 : 0) : (b[sortKey] || '').toString().toLowerCase();

            if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
            if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
            return 0;
        });

        renderer.renderFilteredLogs(this.currentFilteredLogs);
        
        // Add this line at the end of the function
        this.toggleExportFilteredLogsBtn(this.currentFilteredLogs.length !== storage.getLogs().length);
    },
    handleSearchInput() {
        const query = document.getElementById('searchInput').value.trim().toLowerCase();
        const logs = storage.getLogs();
        const monthYearRegex = /^(0?[1-9]|1[0-2])\/((\d{4})|(\d{2}))$/;
        const specificDateRegex = /^(0?[1-9]|1[0-2])\/(0?[1-9]|[12]\d|3[01])\/((\d{4})|(\d{2}))$/;
        const dateRangeRegex = /^(\d{1,2}\/\d{1,2}\/(?:\d{2}|\d{4}))\s*-\s*(\d{1,2}\/\d{1,2}\/(?:\d{2}|\d{4}))$/;

        let filteredLogs = [];

        if (query === 'existing ticket' || query === 'existing tickets') {
            filteredLogs = logs.filter(log => log.existingCase);
        } else if (dateRangeRegex.test(query)) {
            const [, start, end] = query.match(dateRangeRegex);
            const startDate = utils.parseDate(start);
            const endDate = utils.parseDate(end);
            endDate.setHours(23, 59, 59, 999);
            filteredLogs = logs.filter(log => {
                const logDate = new Date(log.date);
                return logDate >= startDate && logDate <= endDate;
            });
        } else if (specificDateRegex.test(query)) {
            const [, month, day, yearPart] = query.match(specificDateRegex);
            const year = yearPart.length === 2 ? `20${yearPart}` : yearPart;
            const searchDate = new Date(year, month - 1, day);
            filteredLogs = logs.filter(log => {
                const logDate = new Date(log.date);
                return logDate.getFullYear() === searchDate.getFullYear() &&
                    logDate.getMonth() === searchDate.getMonth() &&
                    logDate.getDate() === searchDate.getDate();
            });
        } else if (monthYearRegex.test(query)) {
            const [, month, yearPart] = query.match(monthYearRegex);
            const year = yearPart.length === 2 ? `20${yearPart}` : yearPart;
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59, 999);
            filteredLogs = logs.filter(log => {
                const logDate = new Date(log.date);
                return logDate >= startDate && logDate <= endDate;
            });
        } else {
            const exactMatches = query.match(/"([^"]*)"/g) || [];
            const regularTerms = query.replace(/"([^"]*)"/g, '').trim().toLowerCase().split(/\s+/);
            filteredLogs = logs.filter(log => {
                const exactMatchFound = exactMatches.every(match => {
                    const term = match.slice(1, -1).toLowerCase();
                    return Object.values(log).some(value => 
                        String(value).toLowerCase() === term ||
                        (term === 'existing ticket' && log.existingCase)
                    );
                });
                const regularTermsFound = regularTerms.every(term =>
                    Object.values(log).some(value => 
                        String(value).toLowerCase().includes(term) ||
                        (term === 'existing' && log.existingCase)
                    )
                );
                return exactMatchFound && regularTermsFound;
            });
        }

        this.currentFilteredLogs = filteredLogs;
        renderer.renderFilteredLogs(filteredLogs);
        
        // Add this line at the end of the function
        this.toggleExportFilteredLogsBtn(filteredLogs.length !== storage.getLogs().length);
    },
    handleDeleteAllLogs() {
        if (confirm('Are you sure you want to delete all call logs? This action cannot be undone.')) {
            localStorage.removeItem('callLogs');
            renderer.renderLogs(this.currentSort.key, this.currentSort.order);
            utils.showNotification('All logs have been deleted.');
        }
    },
    handleAddTestData() {
        const testData = formHandler.generateTestData();
        const newLogs = [...storage.getLogs(), ...testData];
        storage.saveLogs(newLogs);
        renderer.renderLogs(this.currentSort.key, this.currentSort.order);
        utils.showNotification('Test data added successfully!');
    },
    handleKeyDown(event) {
        if (event.key === 'Escape') {
            if (!document.getElementById('formSection').classList.contains('hidden')) {
                formHandler.hideForm();
            }
            this.hideHelpModal();
            this.closeScratchNotesPanel(); // Add this line
        }
    },
    handleDateTimeChange(event) {
        const newDate = new Date(event.target.value).toISOString();
        const logs = storage.getLogs();
        const logIndex = logs.findIndex(log => log.id === this.currentEditId);
        if (logIndex !== -1) {
            logs[logIndex].date = newDate;
            storage.saveLogs(logs);
            renderer.renderLogs(this.currentSort.key, this.currentSort.order);
        }
    },
    handleRowSelection(event) {
        const row = event.target.closest('tr');
        if (row && !event.target.classList.contains('delete-btn')) {
            this.currentlySelectedLogId = parseInt(row.dataset.id);
            this.updateSelectedRow();
        }
    },
    updateSelectedRow() {
        document.querySelectorAll('#logsTable tbody tr').forEach(row => {
            row.classList.toggle('selected', parseInt(row.dataset.id) === this.currentlySelectedLogId);
        });
    },
    showHelpModal() {
        document.getElementById('helpModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    },
    hideHelpModal() {
        document.getElementById('helpModal').style.display = 'none';
        document.body.style.overflow = '';
    },
    generateNotes() {
        const callerName = document.getElementById('callerName').value;
        const notes = document.getElementById('notes').value;
        const formattedNotes = `${callerName} called in with ${notes}`;
        navigator.clipboard.writeText(formattedNotes).then(() => utils.showNotification('Notes copied to clipboard!'));
    },
    generateTitle() {
        const state = document.getElementById('state').value;
        const vendorID = document.getElementById('vendorID').value;
        const notes = document.getElementById('notes').value;
        const firstSentence = notes.split('.')[0].trim();
        const title = `${state} - ${vendorID} - ${firstSentence}`;
        navigator.clipboard.writeText(title).then(() => utils.showNotification('Title copied to clipboard!'));
    },
    createNewLogFromForm() {
        const formSection = document.getElementById('formSection');
        formSection.classList.remove('active');
        setTimeout(() => {
            formHandler.handleCreateNewLog();
            formSection.classList.add('active');
        }, 300);
        renderer.renderLogs(this.currentSort.key, this.currentSort.order);
    },
    scrollToBottom() {
        const formSection = document.getElementById('formSection');
        const formContent = document.querySelector('.form-content');
        formSection.scrollTo({
            top: formContent.scrollHeight,
            behavior: 'smooth'
        });
    },
    scratchNotes: JSON.parse(localStorage.getItem('scratchNotes')) || [''],
    openScratchNotesPanel() {
        const panel = document.getElementById('scratchNotesPanel');
        const overlay = document.getElementById('overlay');
        panel.classList.add('open');
        overlay.style.display = 'block';
        this.renderScratchNotes();
        document.addEventListener('mousedown', this.handleOutsideClick);

        // Add this: Focus on the last scratch note input
        setTimeout(() => {
            const inputs = document.querySelectorAll('.scratch-note-input');
            if (inputs.length > 0) {
                const lastInput = inputs[inputs.length - 1];
                lastInput.focus();
                // Place the cursor at the end of the text
                lastInput.setSelectionRange(lastInput.value.length, lastInput.value.length);
            }
        }, 0);
    },
    closeScratchNotesPanel() {
        const panel = document.getElementById('scratchNotesPanel');
        const overlay = document.getElementById('overlay');
        panel.classList.remove('open');
        overlay.style.display = 'none';
        document.removeEventListener('mousedown', this.handleOutsideClick);
    },
    handleOutsideClick(event) {
        const panel = document.getElementById('scratchNotesPanel');
        const button = document.getElementById('scratchNotesBtn');
        if (!panel.contains(event.target) && event.target !== button) {
            app.closeScratchNotesPanel();
        }
    },
    renderScratchNotes() {
        const container = document.getElementById('scratchNotesContainer');
        container.innerHTML = '';
        
        // Ensure there's at least one note
        if (this.scratchNotes.length === 0) {
            this.scratchNotes.push('');
        }
        
        this.scratchNotes.forEach((note, index) => {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'scratch-note-line';
            
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-line-btn';
            copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
            copyBtn.addEventListener('click', () => this.copyNoteToClipboard(index));
            
            const textarea = document.createElement('textarea');
            textarea.className = 'scratch-note-input';
            textarea.value = note;
            textarea.rows = 1;
            textarea.addEventListener('input', (e) => {
                this.updateScratchNote(index, e.target.value);
                e.target.style.height = 'auto';
                e.target.style.height = e.target.scrollHeight + 'px';
            });
            textarea.addEventListener('keydown', (e) => this.handleScratchNoteKeydown(e, index));
            
            lineDiv.appendChild(copyBtn);
            lineDiv.appendChild(textarea);
            container.appendChild(lineDiv);
            
            // Set initial height
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        });
    },
    updateScratchNote(index, value) {
        this.scratchNotes[index] = value;
        localStorage.setItem('scratchNotes', JSON.stringify(this.scratchNotes));
        
        // Automatic creation of a new field when typing has been removed
    },
    handleScratchNoteKeydown(event, index) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            this.scratchNotes.splice(index + 1, 0, '');
            this.renderScratchNotes();
            // Focus on the newly created input
            setTimeout(() => {
                const inputs = document.querySelectorAll('.scratch-note-input');
                if (inputs[index + 1]) {
                    inputs[index + 1].focus();
                }
            }, 0);
        } else if (event.key === 'Backspace' && event.target.value === '') {
            event.preventDefault();
            if (this.scratchNotes.length > 1) {
                this.scratchNotes.splice(index, 1);
                this.renderScratchNotes();
                // Focus on the previous input
                setTimeout(() => {
                    const inputs = document.querySelectorAll('.scratch-note-input');
                    if (inputs[index - 1]) {
                        inputs[index - 1].focus();
                        // Place cursor at the end of the text
                        const len = inputs[index - 1].value.length;
                        inputs[index - 1].setSelectionRange(len, len);
                    }
                }, 0);
            }
        }
    },
    copyNoteToClipboard(index) {
        const note = this.scratchNotes[index];
        navigator.clipboard.writeText(note).then(() => {
            utils.showNotification('text copied to clipboard!');
        });
    },
    initializeScratchNotes() {
        const panel = document.getElementById('scratchNotesPanel');
        const button = document.getElementById('scratchNotesBtn');

        button.addEventListener('click', (event) => {
            event.stopPropagation();
            this.openScratchNotesPanel();
        });

        document.getElementById('overlay').addEventListener('click', () => {
            app.closeScratchNotesPanel();
        });
    },
    deleteAllScratchNotes() {
        if (confirm('Are you sure you want to delete all scratch notes? This action cannot be undone.')) {
            this.scratchNotes = [''];
            localStorage.setItem('scratchNotes', JSON.stringify(this.scratchNotes));
            this.renderScratchNotes();
            utils.showNotification('All scratch notes have been deleted.');
        }
    },
    toggleExportFilteredLogsBtn(show) {
        const btn = document.getElementById('exportFilteredLogsBtn');
        if (show) {
            btn.classList.remove('hidden');
        } else {
            btn.classList.add('hidden');
        }
    }
};

// Main Initialization
const init = () => {
    // Create New Log
    document.getElementById('createNewLogBtn').addEventListener('click', () => formHandler.handleCreateNewLog());

    // Close Form
    document.getElementById('closeFormBtn').addEventListener('click', formHandler.hideForm);
    document.getElementById('closeFormBtnTop').addEventListener('click', formHandler.hideForm);

    // Form Submission
    document.getElementById('callForm').addEventListener('submit', formHandler.handleFormSubmit);

    // Form Inputs (Auto-save)
    document.querySelectorAll('#callForm input, #callForm textarea, #callForm select').forEach(input => {
        input.addEventListener('input', app.autoSave.bind(app));
        input.addEventListener('change', app.autoSave.bind(app));
    });

    // Delete Buttons & Row Clicks
    document.querySelector('#logsTable tbody').addEventListener('click', event => {
        const deleteBtn = event.target.closest('.delete-btn');
        const row = event.target.closest('tr');
        if (row) {
            const logId = parseInt(row.dataset.id);
            if (deleteBtn) {
                app.handleDelete(logId);
            } else {
                app.handleEdit(logId);
                app.handleRowSelection(event);
            }
        }
    });

    // Table Headers (Sorting)
    document.querySelectorAll('#logsTable th').forEach(th => th.addEventListener('click', app.handleSort.bind(app)));

    // Search Input
    document.getElementById('searchInput').addEventListener('input', app.handleSearchInput.bind(app));

    // Export Logs
    document.getElementById('exportLogsBtn').addEventListener('click', importExportHandler.handleExportLogs.bind(importExportHandler));

    // Import Logs
    document.getElementById('importLogsBtn').addEventListener('click', () => {
        document.getElementById('fileInput').value = '';
        document.getElementById('fileInput').click();
    });
    document.getElementById('fileInput').addEventListener('change', importExportHandler.handleImportLogs.bind(importExportHandler));

    // Import Modal Buttons
    document.getElementById('overwriteBtn').addEventListener('click', importExportHandler.overwriteLogs.bind(importExportHandler));
    document.getElementById('appendBtn').addEventListener('click', importExportHandler.appendLogs.bind(importExportHandler));
    document.getElementById('cancelImportBtn').addEventListener('click', importExportHandler.hideImportModal.bind(importExportHandler));

    // Delete All Logs
    document.getElementById('deleteAllLogsBtn').addEventListener('click', app.handleDeleteAllLogs.bind(app));

    // Add Test Data
    document.getElementById('addTestDataBtn').addEventListener('click', app.handleAddTestData.bind(app));

    // Keydown Events
    document.addEventListener('keydown', app.handleKeyDown.bind(app));

    // Date-Time Input Change
    document.getElementById('dateTime').addEventListener('change', app.handleDateTimeChange.bind(app));

    // Help Modal
    document.getElementById('helpIcon').addEventListener('click', app.showHelpModal.bind(app));
    document.getElementById('helpModal').addEventListener('click', (event) => {
        if (event.target === document.getElementById('helpModal')) {
            app.hideHelpModal();
        }
    });

    // Equipment Buttons
    document.getElementById('addEquipmentBtn').addEventListener('click', equipmentHandler.addEquipment.bind(equipmentHandler));
    document.getElementById('equipmentContainer').addEventListener('click', (event) => {
        if (event.target.classList.contains('remove-equipment-btn')) {
            equipmentHandler.removeEquipment(event);
            app.updateNotesWithAddressAndEquipment();
        }
    });

    // Generate Buttons
    document.getElementById('generateTitleBtn').addEventListener('click', app.generateTitle.bind(app));
    document.getElementById('generateNotesBtn').addEventListener('click', app.generateNotes.bind(app));

    // Create New Log from Form
    document.getElementById('createNewLogFromFormBtn').addEventListener('click', app.createNewLogFromForm.bind(app));

    // Scratch Notes Panel
    document.getElementById('scratchNotesBtn').addEventListener('click', (event) => {
        event.stopPropagation();
        app.openScratchNotesPanel();
    });

    // Add event listener for 'Delete All' scratch notes button
    document.getElementById('deleteAllScratchNotesBtn').addEventListener('click', () => app.deleteAllScratchNotes());

    // Add event listeners for address and equipment changes
    document.getElementById('replacementAddress').addEventListener('input', app.updateNotesWithAddressAndEquipment.bind(app));
    document.getElementById('equipmentContainer').addEventListener('input', app.updateNotesWithAddressAndEquipment.bind(app));
    document.getElementById('vendorName').addEventListener('input', app.updateNotesWithAddressAndEquipment.bind(app));
    document.getElementById('vendorID').addEventListener('input', app.updateNotesWithAddressAndEquipment.bind(app));
    document.getElementById('caseNumber').addEventListener('input', app.updateNotesWithAddressAndEquipment.bind(app));
    document.getElementById('state').addEventListener('change', app.updateNotesWithAddressAndEquipment.bind(app));

    // Initialize Scratch Notes
    app.renderScratchNotes();
    app.initializeScratchNotes();

    // Initial Render
    if (app.currentSort.key) {
        const th = document.querySelector(`#logsTable th[data-key="${app.currentSort.key}"]`);
        if (th) th.classList.add(`sorted-${app.currentSort.order}`);
    }
    renderer.renderLogs(app.currentSort.key, app.currentSort.order);
    app.currentFilteredLogs = storage.getLogs();
    
    // Add this line
    app.toggleExportFilteredLogsBtn(false);

    // Add event listener for the replacement checkbox
    document.getElementById('replacementCheckbox').addEventListener('change', (event) => {
        app.updateNotesWithAddressAndEquipment();
        app.autoSave(event);
    });

    // Export Filtered Logs
    document.getElementById('exportFilteredLogsBtn').addEventListener('click', importExportHandler.exportFilteredLogs.bind(importExportHandler));

    // Add this to your existing init function in script.js

    const optionsMenu = document.querySelector('.options-menu');
    const additionalButtons = document.querySelector('.additional-buttons');
    let isMenuOpen = false;

    optionsMenu.addEventListener('mouseenter', () => {
        isMenuOpen = true;
        additionalButtons.classList.add('active');
    });

    optionsMenu.addEventListener('mouseleave', () => {
        isMenuOpen = false;
        setTimeout(() => {
            if (!isMenuOpen) {
                additionalButtons.classList.remove('active');
            }
        }, 100);
    });

    additionalButtons.addEventListener('mouseenter', () => {
        isMenuOpen = true;
    });

    additionalButtons.addEventListener('mouseleave', () => {
        isMenuOpen = false;
        setTimeout(() => {
            if (!isMenuOpen) {
                additionalButtons.classList.remove('active');
            }
        }, 100);
    });
};

// Start the application
window.onload = init;

</script>
</body>
</html>